<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>22k Prompter v5.1 – 真·終極版</title>
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #fff0f5; padding: 20px; max-width: 900px; margin: auto; }
        .face { background: #fff; border-radius: 16px; padding: 20px; margin: 15px 0; box-shadow: 0 6px 18px rgba(255,105,145,0.15); }
        h1 { text-align: center; color: #e91e63; font-size: 1.8em; margin-bottom: 10px; }
        h2 { color: #e91e63; margin: 0 0 12px; font-size: 1.3em; }
        button { background: #ff6b9d; color: white; padding: 10px 16px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #c2185b; }
        .upload-label { display: block; border: 3px dashed #ff6b9d; padding: 20px; text-align: center; border-radius: 14px; background: #fff8fb; cursor: pointer; margin: 10px 0; }
        .upload-label:hover { background: #ffe6f0; }
        .upload-label img { max-height: 100px; border-radius: 10px; margin-top: 10px; display: block; margin: 10px auto; }
        input[type="file"] { display: none; }
        video { max-width: 100%; border-radius: 12px; margin-top: 12px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .output { margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 10px; font-size: 14px; }
        .download { background: #4caf50; font-size: 13px; padding: 6px 12px; }
        .mic { background: #ff6b9d; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; line-height: 40px; text-align: center; display: inline-block; }
        .msg { text-align: center; font-size: 12px; color: #777; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>22k Prompter v5.1 – 真·終極版</h1>

    <!-- Face 1 -->
    <div class="face">
        <h2>Face 1: 粉紅跳水 + 語音輸入</h2>
        <button onclick="loadPrompt()">載入模板</button>
        <span class="mic" onclick="startVoice()">Speak</span>
        <textarea id="prompt" placeholder="說話或手打..." style="width:100%; height:60px; margin-top:8px; border-radius:8px; padding:10px; border:1px solid #ff6b9d; font-size:14px;"></textarea>
        <div class="output" id="promptOut"></div>
    </div>

    <!-- Face 2 -->
    <div class="face">
        <h2>Face 2: 圖片 → 6秒轉場影片</h2>
        <label class="upload-label" for="file1">
            <p><strong>圖片 1（左）</strong></p>
            <div id="preview1"></div>
        </label>
        <input type="file" id="file1" accept="image/*">
        
        <label class="upload-label" for="file2">
            <p><strong>圖片 2（右）</strong> <small>（可留空）</small></p>
            <div id="preview2"></div>
        </label>
        <input type="file" id="file2" accept="image/*">
        
        <button onclick="makeVideo()">生成轉場影片</button>
        <video id="result" controls loop></video>
        <button class="download" id="dl" style="display:none;" onclick="downloadMP4()">下載 MP4</button>
    </div>

    <!-- Face 3 -->
    <div class="face">
        <h2>Face 3: 一鍵生成粉紅跳水</h2>
        <button onclick="genImage()">4K 圖片</button>
        <button onclick="genVideo()">6 秒影片</button>
        <div id="genOut"></div>
    </div>

    <!-- 留言 -->
    <div class="face">
        <h2>留個言給我</h2>
        <textarea id="msg" placeholder="bug？建議？直接說！" style="width:100%; height:50px; border-radius:8px; padding:10px; border:1px solid #ff6b9d;"></textarea>
        <button onclick="toGitHub()">送出 → GitHub</button>
        <div id="status" style="color:green; margin-top:8px;"></div>
    </div>

    <canvas id="canvas" width="800" height="800" style="display:none;"></canvas>

    <div class="msg">v5.1 真·終極 | 離線可用 | 語音 + 留言 | 必回</div>

    <script>
        let img1 = null, img2 = null, videoBlob = null;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('result');

        // === Face 1 ===
        function loadPrompt() {
            const t = "粉紅比基尼，陽光下跳水，水花四濺，濕髮甩動，開心大笑，夏日氛圍, smooth motion, water droplets, 4K";
            document.getElementById('prompt').value = t;
            showPrompt(t);
        }
        function showPrompt(t) {
            document.getElementById('promptOut').innerHTML = `<b>提示：</b><br><code style="background:#ffeef8;padding:8px;border-radius:8px;display:block;font-size:13px;">${t}</code>`;
        }

        // 語音輸入
        let recognition;
        function startVoice() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                alert("你的瀏覽器不支援語音輸入");
                return;
            }
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'zh-TW';
            recognition.onresult = e => {
                const text = e.results[0][0].transcript;
                document.getElementById('prompt').value = text;
                showPrompt(text);
            };
            recognition.onerror = () => alert("語音辨識失敗");
            recognition.start();
        }

        // === 上傳（用 label 綁定）===
        document.getElementById('file1').onchange = () => handleFile(1);
        document.getElementById('file2').onchange = () => handleFile(2);

        function handleFile(n) {
            const file = document.getElementById(`file${n}`).files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    window[`img${n}`] = img;
                    document.getElementById(`preview${n}`).innerHTML = `<img src="${e.target.result}" alt="圖${n}">`;
                };
                img.onerror = () => alert(`圖片 ${n} 載入失敗`);
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // === Face 2: 生成影片 ===
        function makeVideo() {
            if (!img1) return alert("請上傳圖片 1！");
            img2 = img2 || img1;

            video.style.display = 'block';
            document.getElementById('dl').style.display = 'none';

            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream);
            const chunks = [];

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                videoBlob = new Blob(chunks, { type: 'video/webm' });
                video.src = URL.createObjectURL(videoBlob);
                document.getElementById('dl').style.display = 'inline';
                video.play().catch(() => {});
            };

            let t = 0;
            const duration = 6000;
            const id = setInterval(() => {
                t += 33;
                if (t >= duration) {
                    clearInterval(id);
                    recorder.stop();
                    return;
                }
                const p = t / duration;
                const ease = 1 - Math.pow(1 - p, 3);

                ctx.clearRect(0, 0, 800, 800);
                ctx.globalAlpha = 1 - ease;
                draw(img1);
                ctx.globalAlpha = ease;
                draw(img2);
                ctx.globalAlpha = 1;
            }, 33);

            function draw(img) {
                const s = Math.max(800/img.width, 800/img.height);
                const w = img.width * s, h = img.height * s;
                ctx.drawImage(img, (800-w)/2, (800-h)/2, w, h);
            }

            recorder.start();
        }

        function downloadMP4() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(videoBlob);
            a.download = '轉場影片.webm';
            a.click();
        }

        // === Face 3 ===
        function genImage() {
            const url = 'https://via.placeholder.com/800x800/FFB6C1/FFFFFF?text=粉紅跳水+4K';
            document.getElementById('genOut').innerHTML = `<img src="${url}"><button class="download" onclick="window.open('${url}')">下載</button>`;
        }
        function genVideo() {
            const url = 'https://cdn.statically.io/gh/adm-shit/test@main/pink-bikini-jump-6s.mp4';
            document.getElementById('genOut').innerHTML += `<br><video controls loop src="${url}"></video><button class="download" onclick="window.open('${url}')">下載</button>`;
        }

        // === 留言 ===
        function toGitHub() {
            const m = document.getElementById('msg').value.trim();
            if (!m) return alert("請輸入留言！");
            window.open(`https://github.com/adm-shit/test/issues/new?title=22k留言&body=${encodeURIComponent(m + "\n\n— v5.1")}`, '_blank');
            document.getElementById('status').innerHTML = "已開啟 GitHub！";
        }

        // 啟動
        window.onload = () => {
            loadPrompt();
            // 強制綁定 label
            document.querySelectorAll('.upload-label').forEach(label => {
                label.addEventListener('click', e => e.stopPropagation());
            });
        };
    </script>
</body>
</html>