<!DOCTYPE html>
<html lang="zh-CN">
<meta charset="utf-8">
<title>HTML-456KBæ‹†åˆ†å™¨ï¼ˆç²¾å‡†ä½“ç§¯ï¼Œå¯¼èˆªé«˜äº®æœ¬ä»½å­—æ¯ï¼‰</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:40px;background:#f7f7f7}
  input{font-size:18px;padding:10px}
  #links{margin-top:20px}
  a{display:inline-block;margin:4px 6px;padding:6px 12px;background:#2196F3;color:#fff;text-decoration:none;border-radius:4px}
  .ok{color:#0a0;font-weight:bold}
</style>

<h2>ğŸ“ é€‰æ‹© HTML æ–‡ä»¶ â†’ ç²¾å‡† 456 KB/ä»½ï¼Œå¯¼èˆªé«˜äº®æœ¬ä»½å­—æ¯</h2>
<input id="f" type="file" accept=".htm,.html">
<div id="prog"></div>
<div id="links"></div>

<script>
const SIZE = 456 * 1024;
const letters = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p'];
const CHUNK  = 8 * 1024 * 1024;   // 8 MB/ç‰‡

const $ = id=>document.getElementById(id);

$('f').addEventListener('change', async e=>{
  const file = e.target.files[0]; if(!file)return;
  $('prog').textContent = 'æ­£åœ¨é¢„å¤„ç†æ®µè¡¨â€¦';
  $('links').innerHTML = '';

  // 1. å¿«é€Ÿå»º 16 æ®µèµ·æ­¢
  const total = file.size;
  const step  = Math.ceil(total / 16);
  const segList = [];
  for(let i=0;i<16;i++){
    let s = Math.min(i*step, total);
    let e = Math.min((i+1)*step, total);
    if(e<total){
      const tail = await file.slice(e-1024, e).text();
      let t = tail.lastIndexOf('>');
      if(t>-1) e = e-1024+t+1;
    }
    segList.push({L:letters[i], start:s, end:e});
  }

  $('prog').textContent = 'å¼€å§‹æ‹†åˆ†â€¦';
  await doSplit(file, segList);
  $('prog').textContent = 'å…¨éƒ¨å®Œæˆï¼';
});

async function doSplit(file, segList){
  let part = 1, idx = 0, segPos = 0;
  let outBody = [];          // åªå­˜å†…å®¹ï¼Œå¯¼èˆªæœ€åæ‹¼
  let existInThisFile = new Set();

  while(idx < 16){
    const seg = segList[idx];
    const L   = seg.L;
    let anchorInserted = false;

    // æŠŠæœ¬æ®µå†ç»†æ‹†ï¼Œç›´åˆ°å†™å®Œ
    while(segPos < seg.end){
      // ç¬¬ä¸€æ¬¡å†™æœ¬æ®µæ—¶æ’é”šç‚¹
      if(!anchorInserted){
        outBody.push(`<p><a name="${L}"></a>ç¬¬${L.toUpperCase()}ç«  <a href="#0">1</a></p>`);
        existInThisFile.add(L);
        anchorInserted = true;
      }

      // å– 8 KB å°ç‰‡
      let left = seg.end - segPos;
      let take = Math.min(left, 8192);
      let off  = seg.start + segPos;
      outBody.push(await file.slice(off, off + take).text());
      segPos += take;

      // å®æ—¶æµ‹ä½“ç§¯ï¼ˆåªæµ‹å†…å®¹ï¼Œä¸å«å¯¼èˆªï¼‰
      let nowSize = new Blob(outBody,{type:'text/html;charset=utf-8'}).size;
      if(nowSize >= SIZE || (idx===15 && segPos>=seg.end)){
        // æ‹¼å¯¼èˆª
        let nav = [`<html><META http-equiv=Content-Type content="text/html; charset=utf-8"><b><font color=green size=7><a name=0></a>`];
        letters.forEach(l=>{
          let cls = existInThisFile.has(l) ? 'class="ok"' : '';
          nav.push(`<a ${cls} href="#${l}">${l}</a> `);
        });
   //     nav.push(`</font></b><hr>`);
        const final = nav.join('') + outBody.join('');

        const blob = new Blob([final], {type:'text/html;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = file.name.replace(/\.htm$/i,'') + `_part_${part}.htm`;
        a.textContent = `ä¸‹è½½ ${a.download}`;
        $('links').appendChild(a);
        $('links').appendChild(document.createElement('br'));
        part++;
        $('prog').textContent = `å·²ç”Ÿæˆ ${part-1} ä»½â€¦`;

        // é‡ç½®ï¼Œå¼€å§‹ä¸‹ä¸€ä»½
        outBody = []; existInThisFile.clear();
      }
      if(segPos >= seg.end) break;
    }
    // æœ¬æ®µå†™å®Œï¼Œè¿›ä¸‹ä¸€æ®µ
    idx++; segPos = 0;
  }
}
</script>
