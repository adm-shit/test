<!DOCTYPE html>
<html lang="zh-CN">
<meta charset="utf-8">
<title>HTML-456KBæ‹†åˆ†å™¨ï¼ˆé€ç‰‡åˆ‡ï¼Œä¸€æ®µå¤šä»½ï¼‰</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:40px;background:#f7f7f7}
  input{font-size:18px;padding:10px}
  #prog{color:#555;margin-top:6px}
  #links{margin-top:20px}
  a{display:inline-block;margin:4px 6px;padding:6px 12px;background:#2196F3;color:#fff;text-decoration:none;border-radius:4px}
</style>

<h2>ğŸ“ é€‰æ‹© HTML æ–‡ä»¶ â†’ é€ç‰‡åˆ‡ï¼Œä¸€æ®µå¯å¤šä»½</h2>
<input id="f" type="file" accept=".htm,.html">
<div id="prog"></div>
<div id="links"></div>

<script>
const SIZE = 456 * 1024;
const letters = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p'];
const SLICE = 8192;   // 8 KB/ç‰‡

const $ = id=>document.getElementById(id);

$('f').addEventListener('change', async e=>{
  const file = e.target.files[0]; if(!file)return;
  $('prog').textContent = 'è¯»å–ä¸­â€¦';
  const fullText = await file.text();
  $('prog').textContent = 'æ‹†åˆ†ä¸­â€¦';

  const total = fullText.length;
  const step  = Math.ceil(total / 16);
  const segList = letters.map((L,i)=>{
    let s = Math.min(i*step, total);
    let e = Math.min((i+1)*step, total);
    let t = fullText.lastIndexOf('>', e); if(t>-1) e = t+1;
    return {L, start:s, end:e};
  });

  let part = 1, idx = 0, segPos = 0, out = [], exist = new Set();

  while(idx < 16){
    const seg = segList[idx];
    const L   = seg.L;
    let anchorDone = false;

    while(segPos < seg.end){
      // é¦–ç‰‡æ’é”šç‚¹
      if(!anchorDone){
        out.push(`<p><a name="${L}"></a>ç¬¬${L.toUpperCase()}ç«  <a href="#0">1</a></p>`);
        exist.add(L);
        anchorDone = true;
      }

      // å– 8 KB å°ç‰‡
      let left = seg.end - segPos;
      let take = Math.min(left, SLICE);
      out.push(fullText.slice(seg.start + segPos, seg.start + segPos + take));
      segPos += take;

      let nowSize = new Blob(out, {type:'text/html;charset=utf-8'}).size;
      if(nowSize >= SIZE || (idx===15 && segPos>=seg.end)){
        // å¯¼èˆªç»“å°¾ï¼šä½ æœ€çˆ±çš„ </font></b><hr>
        let nav = `<html><META http-equiv=Content-Type content="text/html; charset=utf-8"><b><font color=green size=7><a name=0></a>`;
        letters.forEach(l=> nav += `<a href="#${l}" ${exist.has(l)?'style="color:#0a0"':''}>${l.toUpperCase()}</a> `);
        nav += '</font></b><hr>';

        const final = nav + out.join('');
        const blob = new Blob([final], {type:'text/html;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = file.name.replace(/\.htm$/i,'') + `_part_${part}.htm`;
        a.textContent = `Part ${part}  (${(nowSize/1024).toFixed(0)} KB)`;
        $('links').appendChild(a);
        $('links').appendChild(document.createElement('br'));

        part++;
        out = [];
        exist.clear();
      }
      if(segPos >= seg.end) break;
    }
    idx++;
    segPos = 0;
  }
  $('prog').textContent = 'å…¨éƒ¨å®Œæˆï¼16lnksAtop';
});
</script>
